<script>
  const clan = [
    { name: "envys", id: "401359" },
    { name: "sinister", id: "2598146" },
    { name: "mauricioae13", id: "9449579" },
    { name: "MrOsoVC8", id: "1485562" }
  ];

  async function loadStats() {
    const tbody = document.getElementById('player-rows');
    // Usamos un proxy diferente y más rápido
    const proxy = "https://api.allorigins.win/get?url=";
    
    for (let p of clan) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><span class="player-name">VENÓN | ${p.name}</span></td>
        <td id="elo-${p.id}" class="elo-val">...</td>
        <td><a href="https://www.aoe2insights.com/user/${p.id}/" target="_blank" class="btn-insights">INSIGHTS ↗</a></td>
      `;
      tbody.appendChild(row);

      // Intentamos obtener los datos
      try {
        // Usamos la URL que mejor funciona con el proxy
        const targetUrl = `https://api.ageofempires.com/api/v1/ageii/GetPlayerProfile?profileId=${p.id}`;
        const res = await fetch(`${proxy}${encodeURIComponent(targetUrl)}`);
        
        if (!res.ok) throw new Error();
        
        const data = await res.json();
        // AllOrigins devuelve un string en .contents, hay que convertirlo a objeto
        const stats = JSON.parse(data.contents);
        
        if (stats && stats.user && stats.user.rating) {
          document.getElementById(`elo-${p.id}`).innerText = stats.user.rating;
        } else {
          document.getElementById(`elo-${p.id}`).innerText = "Sin datos";
        }
      } catch (e) {
        console.error("Error con el jugador " + p.name, e);
        document.getElementById(`elo-${p.id}`).innerText = "Error";
      }
    }
  }

  // Ejecutar al cargar la página
  window.onload = loadStats;
</script>
